name: Cucumber Test Automation

on:
  push:
    branches: [ main, develop ] # Triggers on your newly renamed 'main' branch
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Test environment'
        required: true
        default: 'qa'
        type: choice
        options: [ qa, staging ]
      browser:
        description: 'Browser'
        required: true
        default: 'chrome'
        type: choice
        options: [ chrome, firefox, edge ]
      profile:
        description: 'Test suite'
        required: true
        default: 'smoke'
        type: choice
        options: [ smoke, regression, sanity, critical, all ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Run Tests
        # 'continue-on-error' ensures the pipeline proceeds to the upload steps 
        # even if Maven returns exit code 1 due to failed tests.
        run: |
          mvn clean test \
            -P${{ github.event.inputs.profile || 'smoke' }} \
            -Denv=${{ github.event.inputs.environment || 'qa' }} \
            -Dbrowser=${{ github.event.inputs.browser || 'chrome' }} \
            -Dheadless=true
        continue-on-error: true 

      - name: Upload Extent Report
        if: always() # This is critical: it runs even if the 'Run Tests' step failed
        uses: actions/upload-artifact@v4
        with:
          name: extent-report
          path: target/ExtentReports/

      - name: Upload Cucumber Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cucumber-report
          path: target/CucumberReports/

      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: target/logs/